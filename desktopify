#!/usr/bin/env bash
set -euo pipefail

# Display help usage
function usage() {
  echo
  echo "Usage"
  echo "  $0 --de <desktop environment>"
  echo
  echo "Available desktop environments are:"
  echo "  lubuntu"
  echo "  kubuntu"
  echo "  ubuntu"
  echo "  ubuntu-budgie"
  echo "  ubuntu-kylin"
  echo "  ubuntu-mate"
  echo "  ubuntu-studio"
  echo "  xubuntu"
  echo
  echo "You can also pass the optional --oem option which will run a setup"
  echo "wizard on the next boot."
}

# Install the specified desktop environment
function install_desktop_environment() {
  local desktop_environment=$1
  case "${desktop_environment}" in
    lubuntu)
      apt-get update
      apt-get install -y lubuntu-desktop
      ;;
    kubuntu)
      apt-get update
      apt-get install -y kubuntu-desktop
      ;;
    ubuntu)
      apt-get update
      apt-get install -y ubuntu-desktop
      ;;
    ubuntu-budgie)
      apt-get update
      apt-get install -y ubuntu-budgie-desktop
      ;;
    ubuntu-kylin)
      apt-get update
      apt-get install -y ubuntukylin-desktop
      ;;
    ubuntu-mate)
      apt-get update
      apt-get install -y ubuntu-mate-desktop
      ;;
    ubuntu-studio)
      apt-get update
      apt-get install -y ubuntustudio-desktop
      ;;
    xubuntu)
      apt-get update
      apt-get install -y xubuntu-desktop
      ;;
    *)
      echo "Unknown desktop environment: ${desktop_environment}"
      usage
      exit 1
      ;;
  esac
}

# Apply specific tweaks for the desktop environment
function apply_tweaks() {
  local desktop_environment=$1

  if [[ "${desktop_environment}" == "ubuntu-mate" ]]; then
    cat <<EOM > /usr/share/glib-2.0/schemas/50_ubuntu-mate-raspi-tweaks.gschema.override
[org.mate.interface]
enable-animations=false

[org.mate.Marco.general]
compositing-manager=false

[org.mate.session.required-components]
windowmanager='marco-no-composite'
EOM
    glib-compile-schemas /usr/share/glib-2.0/schemas/
  fi

  cat <<EOM > "/boot/firmware/usercfg.txt"
# Place "config.txt" changes (dtparam, dtoverlay, disable_overscan, etc.) in
# this file. Please refer to the README file for a description of the various
# configuration files on the boot partition.

# Enable DRM VC4 V3D driver and configure CMA (Contiguous Memory Allocator) with 512MB
dtoverlay=vc4-kms-v3d,cma-size=512
max_framebuffers=2

# Allocate 512MB of memory to the GPU
gpu_mem=512

# Enable audio (loads snd_bcm2835)
dtparam=audio=on

# Automatically load overlays for detected cameras
camera_auto_detect=1

# Automatically load overlays for detected DSI displays
display_auto_detect=1

# Automatically load initramfs files, if found
auto_initramfs=1

# Don't have the firmware create an initial video= setting in cmdline.txt.
# Use the kernel's default instead.
disable_fw_kms_setup=1

# Run in 64-bit mode
arm_64bit=1

# Disable compensation for displays with overscan
disable_overscan=1

# Run as fast as firmware / board allows
arm_boost=1

# Uncomment some or all of these to enable the optional hardware interfaces
#dtparam=i2c_arm=on
#dtparam=i2s=on
#dtparam=spi=on

# Additional overlays and parameters are documented
# /boot/firmware/overlays/README

[all]
EOM

  echo "net.ifnames=0 dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=LABEL=writable rootfstype=ext4 elevator=deadline rootwait fixrtc quiet splash plymouth.ignore-serial-consoles" > "/boot/firmware/cmdline.txt"
}

# Configure network settings
function configure_network() {
  echo "[+] Configuring network..."
  # Disable cloud-init from managing the network
  echo "network: {config: disabled}" > /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg

  # Instruct netplan to hand all network management to NetworkManager
  cat <<EOM > /etc/netplan/01-network-manager-all.yaml
# Let NetworkManager manage all devices on this system
network:
  version: 2
  renderer: NetworkManager
EOM

  # Disable Wifi Powersaving to improve Pi WiFi performance
  if [[ -f /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf ]]; then
    sed -i 's/wifi.powersave = 3/wifi.powersave = 2/' /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
  else
    echo -e "[connection]\nwifi.powersave = 2" > /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
  fi
}

# Main function to parse arguments and execute necessary functions
function main() {
  local desktop_environment=""
  local oem_setup=false

  # Parse command line arguments
  while [[ "$#" -gt 0 ]]; do
    case $1 in
      --de) desktop_environment="$2"; shift ;;
      --oem) oem_setup=true ;;
      *) echo "Unknown parameter passed: $1"; usage; exit 1 ;;
    esac
    shift
  done

  if [[ -z "${desktop_environment}" ]]; then
    echo "Error: No desktop environment specified."
    usage
    exit 1
  fi

  # Install the specified desktop environment
  install_desktop_environment "${desktop_environment}"

  # Apply desktop-specific tweaks
  apply_tweaks "${desktop_environment}"

  # Configure network
  configure_network

  echo "[+] Conversion to ${desktop_environment} complete."
  if [[ "${oem_setup}" == true ]]; then
    echo "[+] OEM setup will run on next boot."
  fi
}

# Execute the main function
main "$@"
